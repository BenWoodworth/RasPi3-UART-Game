# Execute this Makefile with:
# make -f Makefile-Pi3

PI3_ARMGNU := "C:/Program Files (x86)/GNU Tools ARM Embedded/6 2017-q1-update/bin/arm-none-eabi"


####################
# Main Directories #
####################
DIR_BUILD   := build/
DIR_OUTPUT  := output/
DIR_SOURCE  := source/
DIR_INCLUDE := include/
DIR_TARGET  := bin/


########################
# Specific Directories #
########################
CORE_DIR := core/
CORE_DIR_SOURCE := $(DIR_SOURCE)$(CORE_DIR)

PI3_DIR        := pi3/
PI3_DIR_BUILD  := $(DIR_BUILD)$(PI3_DIR)
PI3_DIR_OUTPUT := $(DIR_OUTPUT)$(PI3_DIR)
PI3_DIR_SOURCE := $(DIR_SOURCE)$(PI3_DIR)
PI3_LINKER     := $(PI3_DIR_SOURCE)kernel_c.ld
PI3_TARGET     := $(DIR_TARGET)$(PI3_DIR)kernel7.img


################
# Source Files #
################
CORE_SOURCE := $(wildcard $(DIR_SOURCE)*.cpp)
CORE_SOURCE += $(wildcard $(CORE_DIR_SOURCE)*.cpp)
CORE_SOURCE += $(wildcard $(CORE_DIR_SOURCE)*/*.cpp)
CORE_SOURCE += $(wildcard $(CORE_DIR_SOURCE)*/*/*.cpp)

PI3_SOURCE := $(CORE_SOURCE)
#PI3_SOURCE += $(PI3_DIR_SOURCE)boot.s
PI3_SOURCE += $(wildcard $(PI3_DIR_SOURCE)*.cpp)
PI3_SOURCE += $(wildcard $(PI3_DIR_SOURCE)*/*.cpp)
PI3_SOURCE += $(wildcard $(PI3_DIR_SOURCE)*/*/*.cpp)


################
# Object Files #
################
PI3_OBJECTS := $(patsubst $(DIR_SOURCE)%.cpp,%.o,$(filter %.cpp,$(PI3_SOURCE)))
PI3_OBJECTS += $(patsubst $(DIR_SOURCE)%.s,%.o,$(filter %.s,$(PI3_SOURCE)))

# Replace "/" with "__", and prepend with PI3_DIR_BUILD
PI3_OBJECTS := $(patsubst %,$(PI3_DIR_BUILD)%,$(subst /,__,$(PI3_OBJECTS)))


######### https://istarc.wordpress.com/2014/07/18/stm32f4-oop-with-embedded-systems/
# Flags #
#########
BASE_FLAGS := -I $(DIR_INCLUDE)
BASE_FLAGS += -Wall -Werror -pedantic -pedantic-errors
BASE_FLAGS += -march=armv8-a -mtune=cortex-a53 -DPI2 -O2
BASE_FLAGS += -ffreestanding

PI3_CXX_FLAGS := $(BASE_FLAGS)
PI3_CXX_FLAGS += -D INJECT_PI3
PI3_CXX_FLAGS += -std=c++11
#PI3_CXX_FLAGS += -lsupc++
#PI3_CXX_FLAGS += -lstdc++ifconfig wlan0
#PI3_CXX_FLAGS += -lgcc
#PI3_CXX_FLAGS += -static-libstdc++
#PI3_CXX_FLAGS += -static-libgcc
PI3_CXX_FLAGS += --specs=nosys.specs
#PI3_CXX_FLAGS += -nostdlib
#PI3_CXX_FLAGS += -lm
#PI3_CXX_FLAGS += -lgcc
#PI3_CXX_FLAGS += -lc
#PI3_CXX_FLAGS += -lnosys
#PI3_CXX_FLAGS += -nostartfiles

PI3_LD_FLAGS := --no-undefined


###############
# Clean files #
###############
CLEAN_FILES := $(wildcard $(PI3_DIR_BUILD)*.o)
CLEAN_FILES := $(wildcard $(PI3_DIR_BUILD)*.elf)


###########
# Targets #
###########
all: pi3

.SECONDEXPANSION:

pi3: $(PI3_TARGET)

$(PI3_TARGET): $(PI3_OBJECTS)
	@$(PI3_ARMGNU)-g++ $^ -o $@ $(PI3_CXX_FLAGS)

#$(PI3_TARGET): $(PI3_DIR_BUILD)output.elf
#	@echo Making: $@
#	@$(PI3_ARMGNU)-objcopy $< -O binary $@
#
#$(PI3_DIR_BUILD)output.elf: $(PI3_OBJECTS)
#	@echo Making: $@
#	@$(PI3_ARMGNU)-ld $^ $(PI3_LD_FLAGS) -o $@ -T $(PI3_LINKER)

$(PI3_DIR_BUILD)%.o: $(DIR_SOURCE)$$(subst __,/,%).cpp
	@echo Making: $@
	@$(PI3_ARMGNU)-g++ -c $< -o $@ $(PI3_CXX_FLAGS)

$(PI3_DIR_BUILD)%.o: $(DIR_SOURCE)$$(subst __,/,%).s
	@echo Making: $@
	@$(PI3_ARMGNU)-as -I $(DIR_SOURCE) -c $< -o $@
